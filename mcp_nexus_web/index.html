<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crash Dump Analyzer</title>
    <link rel="stylesheet" href="styles.css?v=20250925193500">
    <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #30363d;
            border-top: 2px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 6px;
        }
        .status-completed { color: #3fb950; }
        .status-processing { color: #f85149; }
        .status-processing-white { color: #ffffff; }
        .status-error { color: #f85149; }
        .status-pending { color: #ffa657; }
        .connection-status {
            display: flex;
            align-items: center;
            margin-right: 12px;
            font-size: 12px;
            color: #7d8590;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
            background: #3fb950;
            animation: pulse 2s infinite;
        }
        .status-dot.disconnected {
            background: #f85149;
            animation: none;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="topbar">
        <div class="topbar-inner">
            <a class="brand" href="#">Crash Dump Analyzer</a>
            <div class="menu">
                <div class="connection-status" id="connectionStatus" title="Real-time updates">
                    <span class="status-dot"></span>
                    <span class="status-text">Live</span>
                </div>
                <button class="upload-btn-header" id="uploadBtn">üìÅ Upload Dumps</button>
                <a href="admin.html" class="upload-btn-header" style="text-decoration: none;">‚öôÔ∏è Admin</a>
            </div>
        </div>
    </div>

    <div class="layout">
        <div class="panel">
            <h2>Analysis Jobs</h2>
            <div class="muted">Server-side queue processing</div>
            <ul id="jobsList"></ul>
        </div>
        <div class="viewer-panel">
            <div class="viewer-title" id="viewerTitle" style="display: none;">Select a job to view details</div>
            <div class="tabs" id="tabsContainer" style="display: none;">
                <div class="tab active" data-type="analysis">Analysis Report</div>
                <div class="tab disabled" data-type="cdb_analyze">WinDbg Output</div>
                <div class="tab disabled" data-type="console">Console Log</div>
                <div class="tab disabled" data-type="dump">Dump File</div>
                <div class="tab" data-type="jobinfo">Job Info</div>
            </div>
            <div class="viewer-body" id="viewerBody">
                <p>Upload dump files to start analysis. Jobs are processed server-side in the background.</p>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Upload Crash Dump Files</h3>
                <span class="close" id="closeModal">&times;</span>
            </div>
            <div class="upload-area" id="uploadArea">
                <input type="file" id="fileInput" accept=".dmp" multiple style="display: none;">
                <div id="uploadContent">
                    <button class="upload-button" onclick="document.getElementById('fileInput').click()">
                        Choose Files
                    </button>
                    <div class="upload-status" id="uploadStatus">
                        Drop dump files here or click to select
                    </div>
                    <div class="upload-help">
                        Supports multiple .dmp files ‚Ä¢ Processed server-side
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        let jobs = [];
        let selectedJob = null;
        let pollInterval = null;
        let durationUpdateInterval = null;
        let isPolling = false;

        // Modal functionality
        const uploadModal = document.getElementById('uploadModal');
        const uploadBtn = document.getElementById('uploadBtn');
        const closeModal = document.getElementById('closeModal');
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const uploadStatus = document.getElementById('uploadStatus');
        
        uploadBtn.addEventListener('click', () => {
            uploadModal.style.display = 'block';
        });
        
        closeModal.addEventListener('click', () => {
            uploadModal.style.display = 'none';
        });
        
        window.addEventListener('click', (e) => {
            if (e.target === uploadModal) {
                uploadModal.style.display = 'none';
            }
        });

        // File upload handling
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                uploadFiles(files);
                e.target.value = '';
                uploadModal.style.display = 'none';
            }
        });

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#238636';
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '#30363d';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#30363d';
            const files = Array.from(e.dataTransfer.files).filter(f => f.name.toLowerCase().endsWith('.dmp'));
            if (files.length > 0) {
                uploadFiles(files);
                uploadModal.style.display = 'none';
            }
        });

        async function uploadFiles(files) {
            for (const file of files) {
                try {
                    uploadStatus.textContent = `Uploading ${file.name}...`;
                    
                    const formData = new FormData();
                    formData.append('dumpFile', file);
                    
                    const response = await fetch('queue-add.aspx', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        console.log('Job added:', result.jobId);
                    } else {
                        console.error('Upload failed:', result.error);
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                }
            }
            
            uploadStatus.textContent = 'Upload complete';
            setTimeout(() => {
                uploadStatus.textContent = 'Drop dump files here or click to select';
            }, 2000);
            
            // Refresh job list
            loadJobs();
        }

        async function loadJobs() {
            try {
                const response = await fetch('queue-status.aspx');
                const result = await response.json();
                
                if (result.success) {
                    jobs = result.jobs || [];
                    
                    // Clean up old tab preferences for jobs that no longer exist
                    cleanupOldTabPreferences();
                    
                    renderJobs();
                } else {
                    console.error('Failed to load jobs:', result.error);
                }
            } catch (error) {
                console.error('Load jobs error:', error);
            }
        }

        function cleanupOldTabPreferences() {
            // Get all localStorage keys that start with 'selectedTab_'
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('selectedTab_')) {
                    const jobId = key.replace('selectedTab_', '');
                    // Check if this job still exists
                    const jobExists = jobs.some(job => job.id === jobId);
                    if (!jobExists) {
                        keysToRemove.push(key);
                    }
                }
            }
            
            // Remove old preferences
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
                console.log('Cleaned up old tab preference:', key);
            });
        }

        function renderJobs() {
            const jobsList = document.getElementById('jobsList');
            
            if (jobs.length === 0) {
                jobsList.innerHTML = '<li style="cursor: default; opacity: 0.7;">No jobs found. Upload dump files to start analysis.</li>';
                return;
            }
            
            jobsList.innerHTML = '';
            
            // Check for saved selection or default to first job
            let jobToSelect = null;
            const savedJobId = localStorage.getItem('selectedJobId');
            
            if (savedJobId) {
                // Try to find the previously selected job
                jobToSelect = jobs.find(job => job.id === savedJobId);
            }
            
            // If no saved selection or saved job not found, select first job
            if (!jobToSelect && jobs.length > 0) {
                jobToSelect = jobs[0];
            }
            
            jobs.forEach(job => {
                const li = document.createElement('li');
                if (selectedJob && selectedJob.id === job.id) {
                    li.classList.add('active');
                }
                
                li.addEventListener('click', () => selectJob(job));
                
                const jobName = document.createElement('div');
                jobName.className = 'job-name';
                jobName.textContent = job.name;
                
                const jobInfo = document.createElement('div');
                jobInfo.className = 'job-info';
                jobInfo.textContent = job.created;
                
                const jobStatus = document.createElement('div');
                jobStatus.className = 'job-status-detailed';
                
                if (job.status === 'processing') {
                    jobStatus.innerHTML = '<span class="spinner"></span> <span class="status-processing-white">PROCESSING</span>';
                } else if (job.status === 'completed') {
                    // Show individual file status indicators
                    const indicators = [
                        { name: 'Analysis', available: job.hasAnalysis || false, title: 'Analysis Report' },
                        { name: 'Windbg', available: job.hasWinDbg || false, title: 'WinDbg Output' },
                        { name: 'AI', available: job.hasConsole || false, title: 'Console Log' },
                        { name: 'Dump', available: job.hasDump || true, title: 'Dump File' }
                    ];
                    
                    jobStatus.innerHTML = indicators.map(ind => 
                        `<span class="status-indicator ${ind.available ? 'available' : 'unavailable'}" title="${ind.title}">${ind.name}</span>`
                    ).join(' ');
                } else {
                    jobStatus.textContent = job.status.toUpperCase();
                    jobStatus.className += ` ${job.status}`;
                }
                
                li.appendChild(jobName);
                li.appendChild(jobInfo);
                li.appendChild(jobStatus);
                
                jobsList.appendChild(li);
            });
            
            // Auto-select the determined job
            if (jobToSelect && (!selectedJob || selectedJob.id !== jobToSelect.id)) {
                selectJob(jobToSelect);
            }
        }

        function selectJob(job) {
            selectedJob = job;
            
            // Save selection to localStorage
            localStorage.setItem('selectedJobId', job.id);
            
            // Also save the selected tab for this job
            const savedTabType = localStorage.getItem(`selectedTab_${job.id}`) || 'analysis';
            localStorage.setItem('currentSelectedTab', savedTabType);
            
            renderJobs(); // Re-render to show selection
            
            const viewerTitle = document.getElementById('viewerTitle');
            const viewerBody = document.getElementById('viewerBody');
            const tabsContainer = document.getElementById('tabsContainer');
            
            viewerTitle.textContent = 'Analysis Results';
            
            if (job.status === 'completed') {
                // Show tabs and load analysis results
                tabsContainer.style.display = 'flex';
                loadAnalysisResults(job.name);
            } else {
                // Hide tabs and show job status
                tabsContainer.style.display = 'none';
                
                let statusText = `Status: ${job.status.toUpperCase()}`;
                if (job.error) {
                    statusText += `\nError: ${job.error}`;
                }
                
                viewerBody.innerHTML = `
                    <div class="job-details-card">
                        <div class="job-details-header">
                            <h2>üìä Job Details</h2>
                            <div class="status-badge status-${job.status.toLowerCase()}">${job.status.toUpperCase()}</div>
                        </div>
                        
                        <div class="job-details-grid">
                            <div class="detail-item">
                                <div class="detail-label">üÜî Job ID</div>
                                <div class="detail-value">${job.id}</div>
                            </div>
                            
                            <div class="detail-item">
                                <div class="detail-label">üìÖ Created</div>
                                <div class="detail-value" id="created-${job.id}"></div>
                            </div>
                            
                            <div class="detail-item">
                                <div class="detail-label">üîÑ Updated</div>
                                <div class="detail-value" id="updated-${job.id}"></div>
                            </div>
                            
                            <div class="detail-item">
                                <div class="detail-label">‚è±Ô∏è Duration</div>
                                <div class="detail-value" id="duration-${job.id}"></div>
                            </div>
                        </div>
                        
                        ${job.error ? `
                        <div class="error-section">
                            <div class="detail-item error-item">
                                <div class="detail-label">‚ùå Error</div>
                                <div class="detail-value error-text">${job.error}</div>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${job.status === 'processing' ? `
                        <div class="processing-indicator">
                            <div class="spinner"></div>
                            <span>Analysis in progress...</span>
                        </div>
                        ` : ''}
                        
                        ${job.status === 'completed' ? `
                        <div class="completion-message">
                            <div class="success-icon">‚úÖ</div>
                            <span>Analysis completed! Select a tab above to view results.</span>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                // Calculate and populate duration (with small delay to ensure DOM is updated)
                setTimeout(() => {
                    // For processing jobs, use current time; for completed jobs, use server time
                    updateDurationDisplay(job, job.status === 'processing');
                    
                    // Start live duration updates for processing jobs
                    if (job.status === 'processing') {
                        startDurationUpdates();
                    } else {
                        stopDurationUpdates();
                    }
                }, 0);
            }
        }

        async function loadAnalysisResults(jobName) {
            try {
                console.log('Loading analysis results for job:', jobName);
                // Load the analysis list to find the corresponding analysis folder
                const response = await fetch('analysis-list.aspx');
                const analyses = await response.json();
                console.log('Available analyses:', analyses);
                
                // Find the analysis that matches this job name (handle timing mismatches)
                let analysis = analyses.find(a => a.name === jobName);
                
                if (!analysis && jobName.startsWith('dump_') && jobName.length >= 17) {
                    // Handle timing mismatches - look for directories with similar pattern
                    const basePattern = jobName.substring(0, 17); // dump_20250928_19
                    console.log('Looking for analysis with base pattern:', basePattern);
                    analysis = analyses.find(a => a.name.startsWith(basePattern));
                    console.log('Found analysis with pattern matching:', analysis);
                }
                
                if (analysis) {
                    console.log('Analysis files:', analysis.files);
                    
                    // Restore the previously selected tab for this job, or default to 'analysis'
                    const savedTabType = localStorage.getItem(`selectedTab_${jobName}`) || 
                                        localStorage.getItem('currentSelectedTab') || 
                                        'analysis';
                    
                    console.log('Restoring tab:', savedTabType, 'for job:', jobName);
                    console.log('Available tabs for this analysis:', Object.keys(analysis.files || {}));
                    
                    // Make sure the tab exists and is available
                    const tabExists = document.querySelector(`[data-type="${savedTabType}"]`);
                    const tabType = (tabExists && (savedTabType === 'jobinfo' || (analysis.files && analysis.files[savedTabType]))) 
                                   ? savedTabType 
                                   : 'analysis';
                    
                    // Load the saved or default tab
                    loadAnalysisContent(analysis, tabType);
                    updateTabStates(analysis);
                } else {
                    console.log('No analysis found for job:', jobName);
                    console.log('Available analysis names:', analyses.map(a => a.name));
                    document.getElementById('viewerBody').innerHTML = '<p>Analysis results not found. The analysis may still be processing.</p>';
                }
            } catch (error) {
                console.error('Failed to load analysis results:', error);
                document.getElementById('viewerBody').innerHTML = '<p>Failed to load analysis results.</p>';
            }
        }

        function updateTabStates(analysis) {
            console.log('updateTabStates called with analysis:', analysis);
            console.log('Available files:', analysis.files);
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                const type = tab.dataset.type;
                console.log('Processing tab type:', type);
                if (type === 'jobinfo') {
                    // Job Info tab is always available
                    tab.classList.remove('disabled');
                    console.log('Enabled jobinfo tab');
                } else if (analysis.files && analysis.files[type]) {
                    tab.classList.remove('disabled');
                    console.log('Enabled tab:', type, 'with file:', analysis.files[type]);
                } else {
                    tab.classList.add('disabled');
                    console.log('Disabled tab:', type, 'no file found');
                }
            });
        }

        function showJobInfo() {
            const viewerBody = document.getElementById('viewerBody');
            
            if (!selectedJob) {
                viewerBody.innerHTML = '<p>No job selected.</p>';
                return;
            }
            
            // Update active tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector('[data-type="jobinfo"]').classList.add('active');
            
            // Save the selected tab for the current job
            if (selectedJob) {
                localStorage.setItem(`selectedTab_${selectedJob.id}`, 'jobinfo');
                localStorage.setItem('currentSelectedTab', 'jobinfo');
            }
            
            const job = selectedJob;
            const createdDate = new Date(job.created);
            const updatedDate = new Date(job.updated);
            const duration = Math.round((updatedDate - createdDate) / 1000); // seconds
            
            viewerBody.innerHTML = `
                <div class="job-info-panel">
                    <div class="job-info-header">
                        <h2>üîç Job Information</h2>
                        <div class="status-badge status-${job.status.toLowerCase()}">${job.status.toUpperCase()}</div>
                    </div>
                    
                    <div class="job-info-sections">
                        <div class="info-section">
                            <h3>üìã Basic Information</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">Job ID:</span>
                                    <span class="info-value monospace">${job.id}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Job Name:</span>
                                    <span class="info-value monospace">${job.name}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">File Name:</span>
                                    <span class="info-value monospace">${job.fileName || 'N/A'}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Status:</span>
                                    <span class="info-value status-${job.status.toLowerCase()}">${job.status.toUpperCase()}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="info-section">
                            <h3>‚è±Ô∏è Timing Information</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">Created:</span>
                                    <span class="info-value">${createdDate.toLocaleString()}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Updated:</span>
                                    <span class="info-value">${updatedDate.toLocaleString()}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Duration:</span>
                                    <span class="info-value">${Math.floor(duration / 60)}m ${duration % 60}s</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">File Path:</span>
                                    <span class="info-value monospace small">${job.filePath || 'N/A'}</span>
                                </div>
                            </div>
                        </div>
                        
                        ${job.error ? `
                        <div class="info-section error-section">
                            <h3>‚ùå Error Information</h3>
                            <div class="error-content">
                                <pre class="error-text">${job.error}</pre>
                            </div>
                        </div>
                        ` : ''}
                        
                        ${job.note ? `
                        <div class="info-section note-section">
                            <h3>üìù Notes</h3>
                            <div class="note-content">
                                <p class="note-text">${job.note}</p>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="info-section">
                            <h3>üîß Technical Details</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">Analysis Directory:</span>
                                    <span class="info-value monospace small">~/analysis/${job.name}/</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Expected Files:</span>
                                    <span class="info-value">analysis.md, cdb_analyze.txt, console.txt, dump.dmp</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Processing Queue:</span>
                                    <span class="info-value">Server-side background processing</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Components:</span>
                                    <span class="info-value">WinDbg Analysis + AI Analysis (cursor-agent)</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="info-section">
                            <h3>üìä Raw Job Data</h3>
                            <div class="raw-data">
                                <pre class="json-data">${JSON.stringify(job, null, 2)}</pre>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadAnalysisContent(analysis, type) {
            const viewerBody = document.getElementById('viewerBody');
            
            if (type === 'jobinfo') {
                // Show job information - always available
                showJobInfo();
                return;
            }
            
            if (!analysis.files || !analysis.files[type]) {
                viewerBody.innerHTML = '<p>Content not available.</p>';
                return;
            }
            
            try {
                const response = await fetch(analysis.files[type].url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const content = await response.text();
                console.log('Raw content loaded:', content.substring(0, 200) + '...');
                
                // Update active tab
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelector(`[data-type="${type}"]`).classList.add('active');
                
                // Save the selected tab for the current job
                if (selectedJob) {
                    localStorage.setItem(`selectedTab_${selectedJob.id}`, type);
                    localStorage.setItem('currentSelectedTab', type);
                }
                
                if (type === 'analysis') {
                    // Render markdown
                    // Function to generate heading IDs
                    function generateId(text) {
                        if (typeof text !== 'string') {
                            text = String(text || '');
                        }
                        return text.toLowerCase()
                            .replace(/[^\w\s-]/g, '') // Remove special characters
                            .replace(/\s+/g, '-')     // Replace spaces with hyphens
                            .replace(/--+/g, '-')     // Replace multiple hyphens with single
                            .trim();
                    }
                    
                    // Parse markdown normally, then add IDs afterward
                    console.log('Parsing markdown content...');
                    try {
                        // Parse markdown without custom renderer first
                        const parsedContent = marked.parse(content);
                        console.log('Parsed content successfully');
                        
                        // Set the content first
                        viewerBody.innerHTML = `<div class="analysis-content markdown-body">${parsedContent}</div>`;
                        
                        // Then add IDs to headings for ToC links
                        const headings = viewerBody.querySelectorAll('h1, h2, h3, h4, h5, h6');
                        headings.forEach(heading => {
                            const text = heading.textContent || '';
                            const id = generateId(text);
                            heading.id = id;
                        });
                        
                        console.log('Added IDs to', headings.length, 'headings');
                    } catch (markedError) {
                        console.error('Marked.js error:', markedError);
                        // Fallback to raw content
                        viewerBody.innerHTML = `<div class="analysis-content markdown-body"><pre>${content}</pre></div>`;
                    }
                } else if (type === 'dump') {
                    // Show dump file info
                    const file = analysis.files[type];
                    viewerBody.innerHTML = `
                        <div class="dump-info">
                            <h3>Dump File Information</h3>
                            <p><strong>Filename:</strong> ${file.name}</p>
                            <p><strong>Size:</strong> ${formatFileSize(file.size)}</p>
                            <p><strong>Modified:</strong> ${file.modified}</p>
                            <a href="${file.url}" class="download-btn" download>üì• Download Dump File</a>
                        </div>
                    `;
                } else {
                    // Show text content (console, cdb_analyze)
                    console.log('Loading text content for type:', type);
                    console.log('Content length:', content.length);
                    // Escape HTML in content to prevent rendering issues
                    const escapedContent = content
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#39;');
                    viewerBody.innerHTML = `<div class="analysis-content"><pre class="text-content">${escapedContent}</pre></div>`;
                }
            } catch (error) {
                console.error('Failed to load content:', error);
                console.error('Error details:', error.message);
                console.error('Analysis object:', analysis);
                console.error('Type requested:', type);
                console.error('Available files:', analysis.files);
                if (analysis.files && analysis.files[type]) {
                    console.error('File URL attempted:', analysis.files[type].url);
                }
                viewerBody.innerHTML = `<p>Failed to load content. Error: ${error.message}<br>Check browser console for details.</p>`;
            }
        }

        function updateDurationDisplay(job, useCurrentTime = false) {
            console.log('updateDurationDisplay called for job:', job.id, 'updated:', job.updated, 'useCurrentTime:', useCurrentTime);
            
            // Update Created time
            const createdElement = document.getElementById(`created-${job.id}`);
            if (createdElement) {
                createdElement.textContent = new Date(job.created).toLocaleString();
                console.log('Updated created time:', new Date(job.created).toLocaleString());
            } else {
                console.log('Created element not found for job:', job.id);
            }
            
            // Update Updated time - for processing jobs, show current time
            const updatedElement = document.getElementById(`updated-${job.id}`);
            if (updatedElement) {
                const displayTime = (useCurrentTime && job.status === 'processing') ? 
                    new Date().toLocaleString() : 
                    new Date(job.updated).toLocaleString();
                updatedElement.textContent = displayTime;
                console.log('Updated updated time:', displayTime);
            } else {
                console.log('Updated element not found for job:', job.id);
            }
            
            // Update Duration
            const durationElement = document.getElementById(`duration-${job.id}`);
            if (durationElement) {
                const created = new Date(job.created);
                // For processing jobs, use current time; for completed jobs, use server timestamp
                const updated = (useCurrentTime && job.status === 'processing') ? 
                    new Date() : 
                    new Date(job.updated);
                const durationMs = updated - created;
                const minutes = Math.floor(durationMs / 60000);
                const seconds = Math.floor((durationMs % 60000) / 1000);
                const durationText = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
                durationElement.textContent = durationText;
                console.log('Updated duration:', durationText);
            } else {
                console.log('Duration element not found for job:', job.id);
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function startPolling() {
            if (pollInterval) clearInterval(pollInterval);
            
            pollInterval = setInterval(() => {
                loadJobs();
            }, 3000); // Poll every 3 seconds
        }

        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        function startDurationUpdates() {
            if (durationUpdateInterval) clearInterval(durationUpdateInterval);
            
            durationUpdateInterval = setInterval(() => {
                if (selectedJob && selectedJob.status === 'processing') {
                    // Use current time for live updates
                    updateDurationDisplay(selectedJob, true);
                }
            }, 1000); // Update every second for processing jobs
        }

        function stopDurationUpdates() {
            if (durationUpdateInterval) {
                clearInterval(durationUpdateInterval);
                durationUpdateInterval = null;
            }
        }

        // Tab click handlers
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                if (!tab.classList.contains('disabled') && selectedJob && selectedJob.status === 'completed') {
                    const type = tab.dataset.type;
                    loadAnalysisResults(selectedJob.name).then(() => {
                        // Find the analysis again and load the specific content
                        fetch('analysis-list.aspx')
                            .then(response => response.json())
                            .then(analyses => {
                                // Find analysis with flexible matching (handle timing mismatches)
                                let analysis = analyses.find(a => a.name === selectedJob.name);
                                
                                if (!analysis && selectedJob.name.startsWith('dump_') && selectedJob.name.length >= 17) {
                                    const basePattern = selectedJob.name.substring(0, 17);
                                    analysis = analyses.find(a => a.name.startsWith(basePattern));
                                }
                                
                                if (analysis) {
                                    loadAnalysisContent(analysis, type);
                                }
                            });
                    });
                }
            });
        });

        // Real-time polling system
        function startPolling() {
            if (isPolling) return; // Prevent multiple polling intervals
            
            isPolling = true;
            console.log('Starting real-time polling...');
            
            // Initial load
            loadJobs();
            
            // Set up polling interval
            pollInterval = setInterval(async () => {
                try {
                    await loadJobsWithStatusTracking();
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 3000); // Poll every 3 seconds
        }

        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
                isPolling = false;
                console.log('Stopped real-time polling');
            }
        }

        async function loadJobsWithStatusTracking() {
            try {
                const response = await fetch('queue-status.aspx');
                const result = await response.json();
                
                // Update connection status
                updateConnectionStatus(true);
                
                if (result.success) {
                    const newJobs = result.jobs || [];
                    
                    // Status changes are now handled by automatic polling updates
                    
                    jobs = newJobs;
                    renderJobs();
                    
                    // Update selected job if it changed
                    if (selectedJob) {
                        const updatedSelectedJob = jobs.find(j => j.id === selectedJob.id);
                        if (updatedSelectedJob && 
                            (updatedSelectedJob.status !== selectedJob.status || 
                             updatedSelectedJob.updated !== selectedJob.updated)) {
                            
                            console.log('Selected job updated:', updatedSelectedJob);
                            selectedJob = updatedSelectedJob;
                            
                            // Update duration if job details are currently showing
                            updateDurationDisplay(updatedSelectedJob);
                            
                            // Refresh the viewer if job completed
                            if (updatedSelectedJob.status === 'completed') {
                                selectJob(updatedSelectedJob);
                            }
                        }
                    }
                } else {
                    console.error('Failed to load jobs:', result.error);
                    updateConnectionStatus(false);
                }
            } catch (error) {
                console.error('Load jobs error:', error);
                updateConnectionStatus(false);
            }
        }

        function updateConnectionStatus(connected) {
            const statusDot = document.querySelector('.status-dot');
            const statusText = document.querySelector('.status-text');
            
            if (statusDot && statusText) {
                if (connected) {
                    statusDot.classList.remove('disconnected');
                    statusText.textContent = 'Live';
                    statusText.style.color = '#7d8590';
                } else {
                    statusDot.classList.add('disconnected');
                    statusText.textContent = 'Offline';
                    statusText.style.color = '#f85149';
                }
            }
        }


        // Initialize
        loadJobs();
        startPolling();

        // Stop polling when page is hidden, resume when visible
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopPolling();
                stopDurationUpdates();
            } else {
                startPolling();
                if (selectedJob && selectedJob.status === 'processing') {
                    startDurationUpdates();
                }
            }
        });

        // Stop polling when page is about to unload
        window.addEventListener('beforeunload', () => {
            stopPolling();
        });

        // Add smooth scrolling for anchor links in markdown content
        document.addEventListener('click', (e) => {
            if (e.target.tagName === 'A' && e.target.hash) {
                const targetId = e.target.hash.substring(1);
                const targetElement = document.getElementById(targetId);
                
                if (targetElement) {
                    e.preventDefault();
                    targetElement.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            }
        });
    </script>
</body>
</html>
